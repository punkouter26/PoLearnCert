@page "/admin"
@using Po.LearnCert.Client.Features.QuestionGeneration
@using Po.LearnCert.Client.Features.Certifications.Services
@using Po.LearnCert.Shared.Models
@inject IQuestionGenerationService GenerationService
@inject ICertificationService CertificationService
@inject ILogger<Admin> Logger

<PageTitle>Admin - Question Generation</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenText TextStyle="TextStyle.H4" Text="Question Generation" Style="margin: 0;" />

    <RadzenCard>
        <RadzenStack Gap="1rem">
            <RadzenText TextStyle="TextStyle.H6" Text="Generate Questions" Style="margin: 0;" />

            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.Caption" Text="Certification" />
                <RadzenDropDown @bind-Value="@selectedCertificationId"
                               Data="@certifications"
                               TextProperty="Name"
                               ValueProperty="Id"
                               Disabled="@isGenerating"
                               Change="@OnCertificationChanged"
                               Placeholder="Select a certification"
                               Style="width: 100%; max-width: 400px;" />
            </RadzenStack>

            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.Caption" Text="Category (Subtopic)" />
                <RadzenDropDown @bind-Value="@selectedSubtopic"
                               Data="@subtopics"
                               TextProperty="Name"
                               Disabled="@(isGenerating || subtopics.Count == 0)"
                               Placeholder="@(string.IsNullOrEmpty(selectedCertificationId) ? "Select a certification first" : "Select a category")"
                               Style="width: 100%; max-width: 400px;" />
            </RadzenStack>

            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.Caption" Text="Number of Questions" />
                <RadzenNumeric @bind-Value="@numberOfQuestions"
                              Min="1" Max="50"
                              Disabled="@isGenerating"
                              Style="width: 150px;" />
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                <RadzenButton Text="Generate Questions"
                             Icon="auto_awesome"
                             Click="@GenerateQuestions"
                             Disabled="@(isGenerating || selectedSubtopic == null)"
                             IsBusy="@isGenerating" />

                @if (isGenerating)
                {
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                        Generating questions... This may take a moment.
                    </RadzenText>
                }
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>

    @if (result != null)
    {
        <RadzenCard>
            <RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">
                    @if (result.TotalFailed == 0)
                    {
                        <RadzenIcon Icon="check_circle" Style="color: var(--rz-success);" />
                        <span>Generation Complete</span>
                    }
                    else
                    {
                        <RadzenIcon Icon="warning" Style="color: var(--rz-warning);" />
                        <span>Generation Complete with Errors</span>
                    }
                </RadzenText>

                <RadzenStack Orientation="Orientation.Horizontal" Gap="2rem" Wrap="FlexWrap.Wrap">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" Text="Generated" />
                        <RadzenText TextStyle="TextStyle.H5" Style="color: var(--rz-success);">
                            @result.TotalGenerated
                        </RadzenText>
                    </RadzenStack>

                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" Text="Failed" />
                        <RadzenText TextStyle="TextStyle.H5" Style="color: var(--rz-danger);">
                            @result.TotalFailed
                        </RadzenText>
                    </RadzenStack>

                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" Text="Duration" />
                        <RadzenText TextStyle="TextStyle.H5">
                            @FormatDuration(result.DurationSeconds)
                        </RadzenText>
                    </RadzenStack>
                </RadzenStack>

                @if (result.Errors.Any())
                {
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Caption" Text="Errors (first 10)" />
                        <RadzenCard Style="background: var(--rz-danger-lighter); max-height: 200px; overflow-y: auto;">
                            @foreach (var error in result.Errors.Take(10))
                            {
                                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-danger-darker);">
                                    @error
                                </RadzenText>
                            }
                        </RadzenCard>
                    </RadzenStack>
                }
            </RadzenStack>
        </RadzenCard>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" ShowIcon="true" Variant="Variant.Flat" Shade="Shade.Lighter">
            @errorMessage
        </RadzenAlert>
    }
</RadzenStack>

@code {
    private string? selectedCertificationId;
    private SubtopicDto? selectedSubtopic;
    private int numberOfQuestions = 5;
    private bool isGenerating = false;
    private GenerationResultDto? result;
    private string? errorMessage;

    private List<CertificationDto> certifications = new();
    private List<SubtopicDto> subtopics = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            certifications = await CertificationService.GetAllCertificationsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load certifications");
            errorMessage = "Failed to load certifications. Please refresh the page.";
        }
    }

    private async Task OnCertificationChanged()
    {
        selectedSubtopic = null;
        subtopics.Clear();
        result = null;
        errorMessage = null;

        if (string.IsNullOrEmpty(selectedCertificationId))
            return;

        try
        {
            subtopics = await CertificationService.GetSubtopicsAsync(selectedCertificationId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load subtopics for {CertificationId}", selectedCertificationId);
            errorMessage = "Failed to load categories. Please try again.";
        }
    }

    private async Task GenerateQuestions()
    {
        if (selectedSubtopic == null || string.IsNullOrEmpty(selectedCertificationId))
            return;

        isGenerating = true;
        result = null;
        errorMessage = null;
        StateHasChanged();

        try
        {
            result = await GenerationService.GenerateForSubtopicAsync(
                selectedCertificationId,
                selectedSubtopic.Id,
                selectedSubtopic.Name,
                numberOfQuestions);

            Logger.LogInformation("Generated {Count} questions for {Subtopic}",
                result.TotalGenerated, selectedSubtopic.Name);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to generate questions");
            errorMessage = $"Failed to generate questions: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private string FormatDuration(double seconds)
    {
        var timeSpan = TimeSpan.FromSeconds(seconds);
        if (timeSpan.TotalMinutes >= 1)
        {
            return $"{timeSpan.Minutes}m {timeSpan.Seconds}s";
        }
        return $"{timeSpan.Seconds}s";
    }
}
