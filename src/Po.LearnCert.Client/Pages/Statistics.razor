@page "/statistics"
@page "/stats"
@using Po.LearnCert.Shared.Models
@using Po.LearnCert.Client.Features.Statistics
@using Po.LearnCert.Client.Features.Statistics.Services
@using Microsoft.AspNetCore.Components.Web
@inject HttpClient Http
@inject IStatisticsService StatisticsService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<PageTitle>Performance Statistics - PoLearnCert</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenStack Gap="0.25rem">
        <RadzenText TextStyle="TextStyle.H4" Text="ðŸ“Š Performance Statistics" Style="margin: 0;" />
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Text="Track your learning progress and identify areas for improvement" />
    </RadzenStack>

    @if (isLoading)
    {
        <StatisticsLoadingSkeleton />
    }
    else if (errorMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter">
            @errorMessage
        </RadzenAlert>
    }
    else if (userStats != null)
    {
        <StatisticsOverviewCards Stats="userStats" />

        @* Certification Performance *@
        @if (userStats.CertificationPerformance.Any())
        {
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.H6" class="rz-mb-4">ðŸŽ“ Certification Performance</RadzenText>
                
                <RadzenRow Gap="1rem">
                    @foreach (var cert in userStats.CertificationPerformance)
                    {
                        <RadzenColumn Size="12" SizeMD="6">
                            <CertificationPerformanceCard 
                                Performance="cert" 
                                OnViewSubtopics="ViewSubtopicPerformance" />
                        </RadzenColumn>
                    }
                </RadzenRow>
            </RadzenCard>
        }

        @* Subtopic Performance Chart Component *@
        <SubtopicPerformanceChart Performance="@subtopicPerformance" />

        @* Progress Trend Chart Component *@
        @if (sessionHistory != null && sessionHistory.Any())
        {
            <ProgressTrendChart SessionHistory="@sessionHistory" />
        }
    }
    else
    {
        <EmptyStatisticsState OnStartQuiz="@(() => Navigation.NavigateTo("/quiz"))" />
    }
</RadzenStack>

@code {
    private UserStatisticsDto? userStats;
    private List<SubtopicPerformanceDto> subtopicPerformance = new();
    private List<SessionSummaryDto> sessionHistory = new();
    private string? selectedCertificationId;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserStatistics();
    }

    private async Task LoadUserStatistics()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var userId = "user1";
            
            var response = await Http.GetAsync($"api/users/{userId}/statistics");
            if (response.IsSuccessStatusCode)
            {
                userStats = await response.Content.ReadFromJsonAsync<UserStatisticsDto>();
            }
            else
            {
                errorMessage = "Failed to load statistics data.";
            }
            
            sessionHistory = await StatisticsService.GetSessionHistoryAsync(userId, limit: 10);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading statistics: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ViewSubtopicPerformance(string certificationId)
    {
        try
        {
            selectedCertificationId = certificationId;
            var userId = "user1";
            
            var response = await Http.GetAsync($"api/users/{userId}/statistics/subtopics?certificationId={certificationId}");
            if (response.IsSuccessStatusCode)
            {
                subtopicPerformance = await response.Content.ReadFromJsonAsync<List<SubtopicPerformanceDto>>() ?? new();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading subtopic performance: {ex.Message}";
        }
    }
}