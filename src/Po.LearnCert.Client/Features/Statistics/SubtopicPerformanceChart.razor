@using Po.LearnCert.Shared.Models
@inject ILogger<SubtopicPerformanceChart> Logger

<RadzenCard class="rz-mt-4">
    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-4">üìö Subtopic Performance</RadzenText>
    
    @if (Performance == null || !Performance.Any())
    {
        <RadzenStack AlignItems="AlignItems.Center" Gap="1rem" class="rz-py-6">
            <RadzenText Text="üìñ" Style="font-size: 2.5rem;" />
            <RadzenText TextStyle="TextStyle.Body1" Text="No subtopic performance data available yet" />
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Text="Complete some quiz sessions to see your performance breakdown by topic" />
        </RadzenStack>
    }
    else
    {
        <RadzenDataGrid Data="@Performance.OrderByDescending(p => p.Accuracy)" 
                       TItem="SubtopicPerformanceDto"
                       AllowSorting="true"
                       Density="Density.Compact"
                       class="rz-datatable-striped">
            <Columns>
                <RadzenDataGridColumn TItem="SubtopicPerformanceDto" Property="SubtopicName" Title="Subtopic" MinWidth="200px">
                    <Template Context="item">
                        <RadzenStack Gap="0.25rem">
                            <RadzenText Text="@item.SubtopicName" Style="font-weight: 500;" />
                            <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@item.CertificationId.ToUpper()" IsPill="true" />
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
                
                <RadzenDataGridColumn TItem="SubtopicPerformanceDto" Property="Accuracy" Title="Accuracy" Width="180px">
                    <Template Context="item">
                        <RadzenStack Gap="0.25rem">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText Text="@($"{item.Accuracy:F1}%")" Style="font-weight: 600;" />
                                <RadzenBadge BadgeStyle="@GetPerformanceBadgeStyle(item.PerformanceLevel)" 
                                            Text="@GetPerformanceLevelText(item.PerformanceLevel)" 
                                            IsPill="true" />
                            </RadzenStack>
                            <RadzenProgressBar Value="@((double)item.Accuracy)" Max="100" ShowValue="false" 
                                              Style="height: 6px;"
                                              ProgressBarStyle="@GetProgressBarStyle(item.PerformanceLevel)" />
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
                
                <RadzenDataGridColumn TItem="SubtopicPerformanceDto" Title="Score" Width="100px" TextAlign="TextAlign.Center">
                    <Template Context="item">
                        <RadzenText Text="@($"{item.CorrectAnswers}/{item.QuestionsAnswered}")" />
                    </Template>
                </RadzenDataGridColumn>
                
                <RadzenDataGridColumn TItem="SubtopicPerformanceDto" Property="PracticeCount" Title="Sessions" Width="90px" TextAlign="TextAlign.Center" />
            </Columns>
        </RadzenDataGrid>
    }
</RadzenCard>

@code {
    [Parameter]
    public List<SubtopicPerformanceDto>? Performance { get; set; }

    private BadgeStyle GetPerformanceBadgeStyle(PerformanceLevel level) => level switch
    {
        PerformanceLevel.Excellent => BadgeStyle.Success,
        PerformanceLevel.Good => BadgeStyle.Info,
        PerformanceLevel.Basic => BadgeStyle.Warning,
        PerformanceLevel.NeedsImprovement => BadgeStyle.Danger,
        _ => BadgeStyle.Light
    };
    
    private ProgressBarStyle GetProgressBarStyle(PerformanceLevel level) => level switch
    {
        PerformanceLevel.Excellent => ProgressBarStyle.Success,
        PerformanceLevel.Good => ProgressBarStyle.Info,
        PerformanceLevel.Basic => ProgressBarStyle.Warning,
        PerformanceLevel.NeedsImprovement => ProgressBarStyle.Danger,
        _ => ProgressBarStyle.Primary
    };

    private string GetPerformanceLevelText(PerformanceLevel level) => level switch
    {
        PerformanceLevel.Excellent => "üåü Excellent",
        PerformanceLevel.Good => "‚úÖ Good",
        PerformanceLevel.Basic => "‚ö†Ô∏è Basic",
        PerformanceLevel.NeedsImprovement => "‚ùå Needs Work",
        _ => "‚ùì"
    };
}
