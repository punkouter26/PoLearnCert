@using Po.LearnCert.Shared.Models
@inject ILogger<ProgressTrendChart> Logger

<RadzenCard class="rz-mt-4">
    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-2">Progress Over Time</RadzenText>
    
    @if (SessionHistory == null || !SessionHistory.Any())
    {
        <RadzenStack AlignItems="AlignItems.Center" Gap="1rem" class="rz-py-6">
            <RadzenText Text="ðŸ“Š" Style="font-size: 2.5rem;" />
            <RadzenText TextStyle="TextStyle.Body1" Text="No session history available yet" />
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Text="Complete quiz sessions to track your progress over time" />
        </RadzenStack>
    }
    else
    {
        @* Summary stats at the top *@
        <RadzenStack Orientation="Orientation.Horizontal" Gap="1.5rem" Wrap="FlexWrap.Wrap" class="rz-mb-4">
            <RadzenStack Gap="0.125rem">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Text="Sessions" />
                <RadzenText TextStyle="TextStyle.H5" Text="@SessionHistory.Count.ToString()" Style="margin: 0;" />
            </RadzenStack>
            <RadzenStack Gap="0.125rem">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Text="Average" />
                <RadzenText TextStyle="TextStyle.H5" Text="@($"{SessionHistory.Average(s => (double)s.ScorePercentage):F1}%")" Style="margin: 0;" />
            </RadzenStack>
            <RadzenStack Gap="0.125rem">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Text="Best" />
                <RadzenText TextStyle="TextStyle.H5" Text="@($"{SessionHistory.Max(s => (double)s.ScorePercentage):F1}%")" Style="margin: 0; color: var(--rz-success);" />
            </RadzenStack>
            <RadzenStack Gap="0.125rem">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Text="Latest" />
                <RadzenText TextStyle="TextStyle.H5" Text="@($"{(double)SessionHistory.Last().ScorePercentage:F1}%")" Style="margin: 0;" />
            </RadzenStack>
        </RadzenStack>
        
        @* Chart *@
        <RadzenChart Style="height: 300px;">
            <RadzenLineSeries Data="@GetChartData()" 
                             CategoryProperty="Date" 
                             ValueProperty="Score"
                             Title="Score %"
                             Smooth="true"
                             Stroke="var(--rz-primary)"
                             StrokeWidth="3">
                <TooltipTemplate Context="data">
                    <div style="padding: 0.5rem;">
                        <strong>@data.CertificationName</strong><br/>
                        Score: @data.Score.ToString("F1")%<br/>
                        @data.DateLabel
                    </div>
                </TooltipTemplate>
            </RadzenLineSeries>
            
            <RadzenAreaSeries Data="@GetChartData()"
                             CategoryProperty="Date"
                             ValueProperty="Score"
                             Stroke="transparent"
                             Fill="var(--rz-primary-lighter)" />
            
            <RadzenCategoryAxis Padding="20" FormatString="{0:MMM dd}">
                <RadzenAxisTitle Text="Date" />
            </RadzenCategoryAxis>
            
            <RadzenValueAxis Min="0" Max="100" Step="25">
                <RadzenGridLines Visible="true" />
                <RadzenAxisTitle Text="Score %" />
            </RadzenValueAxis>
            
            <RadzenLegend Visible="false" />
            <RadzenChartTooltipOptions Visible="true" />
        </RadzenChart>
    }
</RadzenCard>

@code {
    [Parameter]
    public List<SessionSummaryDto>? SessionHistory { get; set; }
    
    private List<ChartDataItem> GetChartData()
    {
        if (SessionHistory == null) return new();
        
        return SessionHistory.Select(s => new ChartDataItem
        {
            Date = s.CompletedAt ?? s.StartedAt,
            DateLabel = (s.CompletedAt ?? s.StartedAt).ToString("MMM dd, yyyy h:mm tt"),
            Score = (double)s.ScorePercentage,
            CertificationName = s.CertificationName
        }).ToList();
    }

    private class ChartDataItem
    {
        public DateTime Date { get; set; }
        public string DateLabel { get; set; } = "";
        public double Score { get; set; }
        public string CertificationName { get; set; } = "";
    }
}
