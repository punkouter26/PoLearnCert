@using Po.LearnCert.Client.Features.Leaderboards.Services
@using Po.LearnCert.Shared.Models
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject ILeaderboardService LeaderboardService
@inject ILogger<LeaderboardView> Logger
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Leaderboards - PoLearnCert</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenText TextStyle="TextStyle.H4" Text="Leaderboards" Style="margin: 0;" />
    
    <RadzenCard>
        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap" class="rz-mb-4">
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.Caption" Text="Certification" />
                <RadzenDropDown @bind-Value="@selectedCertId" 
                               Data="@certifications" 
                               TextProperty="Name" 
                               ValueProperty="Id"
                               Change="@OnFilterChanged"
                               Disabled="@isLoading"
                               Style="min-width: 280px;" />
            </RadzenStack>
            
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.Caption" Text="Time Period" />
                <RadzenDropDown @bind-Value="@selectedTimePeriod" 
                               Data="@timePeriods" 
                               TextProperty="Name" 
                               ValueProperty="Id"
                               Change="@OnFilterChanged"
                               Disabled="@isLoading"
                               Style="min-width: 150px;" />
            </RadzenStack>
        </RadzenStack>

        @if (isLoading)
        {
            <RadzenStack Gap="0.75rem">
                @for (int i = 0; i < 5; i++)
                {
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center" class="rz-py-3 rz-border-bottom">
                        <RadzenSkeleton Shape="SkeletonShape.Circle" Width="40px" Height="40px" />
                        <RadzenSkeleton Width="150px" Height="20px" />
                        <RadzenSkeleton Width="80px" Height="20px" Style="margin-left: auto;" />
                    </RadzenStack>
                }
            </RadzenStack>
        }
        else if (leaderboard == null || !leaderboard.Entries.Any())
        {
            <RadzenStack AlignItems="AlignItems.Center" Gap="1rem" class="rz-py-6">
                <RadzenText Text="ðŸ…" Style="font-size: 3rem;" />
                <RadzenText TextStyle="TextStyle.H6" Text="No leaderboard entries yet" />
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Text="Be the first to take a quiz and claim the top spot!" />
                <RadzenButton Text="Start Quiz" Icon="play_arrow" Click="@(() => Navigation.NavigateTo("/quiz"))" />
            </RadzenStack>
        }
        else
        {
            <RadzenStack Gap="0.5rem" class="rz-mb-4">
                <RadzenText TextStyle="TextStyle.H6" Text="@leaderboard.CertificationName" Style="margin: 0;" />
                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                    <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@GetTimePeriodDisplay(leaderboard.TimePeriod)" />
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                        @leaderboard.TotalEntries participants
                    </RadzenText>
                </RadzenStack>
            </RadzenStack>

            <RadzenDataGrid @ref="grid" 
                           Data="@leaderboard.Entries" 
                           TItem="LeaderboardEntryDto"
                           AllowPaging="true" 
                           PageSize="15"
                           PagerHorizontalAlign="HorizontalAlign.Center"
                           AllowSorting="true"
                           Density="Density.Compact"
                           RowRender="@OnRowRender">
                <Columns>
                    <RadzenDataGridColumn TItem="LeaderboardEntryDto" Title="Rank" Width="80px" TextAlign="TextAlign.Center" Sortable="false">
                        <Template Context="entry">
                            @if (entry.Rank <= 3)
                            {
                                <RadzenBadge BadgeStyle="@GetMedalStyle(entry.Rank)" IsPill="true" Style="font-size: 1rem;">
                                    @GetMedalEmoji(entry.Rank)
                                </RadzenBadge>
                            }
                            else
                            {
                                <RadzenText Text="@($"#{entry.Rank}")" class="rz-color-secondary" />
                            }
                        </Template>
                    </RadzenDataGridColumn>
                    
                    <RadzenDataGridColumn TItem="LeaderboardEntryDto" Property="Username" Title="User" MinWidth="150px">
                        <Template Context="entry">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenText Text="@entry.Username" Style="@(entry.IsCurrentUser ? "font-weight: 600;" : "")" />
                                @if (entry.IsCurrentUser)
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="You" IsPill="true" />
                                }
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                    
                    <RadzenDataGridColumn TItem="LeaderboardEntryDto" Property="BestScore" Title="Best Score" Width="120px" TextAlign="TextAlign.End">
                        <Template Context="entry">
                            <RadzenText Text="@($"{entry.BestScore}%")" Style="font-weight: 600; color: var(--rz-primary);" />
                        </Template>
                    </RadzenDataGridColumn>
                    
                    <RadzenDataGridColumn TItem="LeaderboardEntryDto" Property="QuizzesTaken" Title="Quizzes" Width="100px" TextAlign="TextAlign.End" class="rz-display-none rz-display-md-table-cell" />
                    
                    <RadzenDataGridColumn TItem="LeaderboardEntryDto" Property="AverageScore" Title="Average" Width="100px" TextAlign="TextAlign.End" FormatString="{0:F1}%" class="rz-display-none rz-display-lg-table-cell" />
                    
                    <RadzenDataGridColumn TItem="LeaderboardEntryDto" Property="LastAttemptDate" Title="Last Attempt" Width="130px" TextAlign="TextAlign.End" FormatString="{0:MMM dd, yyyy}" class="rz-display-none rz-display-xl-table-cell" />
                </Columns>
            </RadzenDataGrid>
        }
    </RadzenCard>
</RadzenStack>

@code {
    private RadzenDataGrid<LeaderboardEntryDto>? grid;
    private LeaderboardDto? leaderboard;
    private bool isLoading = true;
    private string selectedCertId = "AZ-900";
    private string selectedTimePeriod = "AllTime";
    private int currentSkip = 0;
    private int currentTake = 50;
    private string? currentUserId;

    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private List<CertOption> certifications = new()
    {
        new("AZ-900", "Microsoft Azure Fundamentals (AZ-900)"),
        new("SecurityPlus", "CompTIA Security+ (SY0-701)")
    };

    private List<TimePeriodOption> timePeriods = new()
    {
        new("AllTime", "All Time"),
        new("Monthly", "This Month"),
        new("Weekly", "This Week")
    };

    protected override async Task OnInitializedAsync()
    {
        // Get current user from authentication state
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value
                         ?? user.Identity.Name;
        }

        await LoadLeaderboard();
    }

    private async Task OnFilterChanged()
    {
        currentSkip = 0;
        await LoadLeaderboard();
    }

    private async Task LoadLeaderboard()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            leaderboard = await LeaderboardService.GetLeaderboardAsync(
                selectedCertId,
                selectedTimePeriod,
                currentSkip,
                currentTake,
                currentUserId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading leaderboard");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void OnRowRender(RowRenderEventArgs<LeaderboardEntryDto> args)
    {
        if (args.Data.IsCurrentUser)
        {
            args.Attributes.Add("style", "background-color: var(--rz-primary-lighter); font-weight: 500;");
        }
    }

    private string GetTimePeriodDisplay(string timePeriod) => timePeriod switch
    {
        "AllTime" => "All Time",
        "Monthly" => "This Month",
        "Weekly" => "This Week",
        _ => timePeriod
    };

    private BadgeStyle GetMedalStyle(int rank) => rank switch
    {
        1 => BadgeStyle.Warning,
        2 => BadgeStyle.Light,
        3 => BadgeStyle.Info,
        _ => BadgeStyle.Secondary
    };

    private string GetMedalEmoji(int rank) => rank switch
    {
        1 => "ðŸ¥‡",
        2 => "ðŸ¥ˆ",
        3 => "ðŸ¥‰",
        _ => ""
    };
    
    private record CertOption(string Id, string Name);
    private record TimePeriodOption(string Id, string Name);
}
